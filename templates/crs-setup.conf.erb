# OWASP Core Rule Set Setup Configuration
# Managed by Chef - DO NOT EDIT MANUALLY

# Paranoia Level (1-4)
# 1 = Low false positives, lower security
# 4 = High false positives, higher security
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=<%= @paranoia_level %>"

# Executing Paranoia Level
SecAction \
    "id:900001,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.executing_paranoia_level=<%= @paranoia_level %>"

# Anomaly scoring thresholds
SecAction \
    "id:900110,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=<%= @anomaly_inbound_threshold %>,\
    setvar:tx.outbound_anomaly_score_threshold=<%= @anomaly_outbound_threshold %>"

# HTTP methods that are allowed
SecAction \
    "id:900200,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Content types that are allowed
SecAction \
    "id:900220,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# HTTP versions that are allowed
SecAction \
    "id:900230,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# File extensions that are restricted
SecAction \
    "id:900240,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# File headers that are restricted
SecAction \
    "id:900250,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.restricted_headers=/content-encoding/ /proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/'"

# CRS version
SecAction \
    "id:900990,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.crs_setup_version=340"

<% if @geoip_enabled -%>
# GeoIP Configuration
SecGeoLookupDB <%= @geoip_database %>

<% if @blocked_countries.any? -%>
# Block requests from specific countries
SecRule REMOTE_ADDR "@geoLookup" \
    "id:910100,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Request from blocked country',\
    chain"
    SecRule GEO:COUNTRY_CODE "@pm <%= @blocked_countries.join(' ') %>" \
        "setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}'"
<% end -%>
<% end -%>
