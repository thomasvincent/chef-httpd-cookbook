# Logging Configuration
# Generated by Chef for <%= node.name %>
# Local modifications will be overwritten

# Determine platform-specific log directory
<% log_dir = node['platform_family'] == 'debian' ? '/var/log/apache2' : '/var/log/httpd' %>

# Error log configuration
ErrorLog "<%= log_dir %>/error.log"
LogLevel <%= node['httpd']['logging']['error_log_level'] || 'warn' %>

<IfModule log_config_module>
    # Define standard log formats
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    LogFormat "%{Referer}i -> %U" referer
    LogFormat "%{User-agent}i" agent
    
    # Define JSON log format if enabled
    LogFormat "{\"timestamp\":\"%t\",\"remoteIp\":\"%a\",\"host\":\"%V\",\"request\":\"%U\",\"query\":\"%q\",\"method\":\"%m\",\"status\":\"%>s\",\"size\":\"%b\",\"userAgent\":\"%{User-agent}i\",\"referer\":\"%{Referer}i\",\"responseTime\":\"%D\"}" json
    
    # Define IO logging format if enabled
    <IfModule mod_logio.c>
        LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>

    # Configure buffering if enabled
    <% if node['httpd']['logging']['buffer_size'].to_i > 0 %>
    BufferedLogs On
    <% end %>
    
    # Set up access logging with appropriate format
    <% if node['httpd']['logging']['json_logging'] %>
        <% if node['httpd']['logging']['buffer_size'].to_i > 0 %>
        CustomLog "<%= log_dir %>/access.log" json <%= node['httpd']['logging']['buffer_size'] %>
        <% else %>
        CustomLog "<%= log_dir %>/access.log" json
        <% end %>
    <% else %>
        <% if node['httpd']['logging']['buffer_size'].to_i > 0 %>
        CustomLog "<%= log_dir %>/access.log" combined <%= node['httpd']['logging']['buffer_size'] %>
        <% else %>
        CustomLog "<%= log_dir %>/access.log" combined
        <% end %>
    <% end %>
</IfModule>

<% if node['httpd']['logging']['rotation']['enabled'] %>
# Log file permissions and ownership
<IfModule mod_unixd.c>
    <Directory "<%= log_dir %>">
        <% if node['platform_family'] == 'debian' %>
        Require all denied
        Options None
        AllowOverride None
        <% if node['httpd']['service_user'] && node['httpd']['service_group'] %>
        # Log directory permissions
        <FilesMatch "^(access|error)\.log$">
            Require all denied
        </FilesMatch>
        <% end %>
        <% end %>
    </Directory>
</IfModule>
<% end %>

